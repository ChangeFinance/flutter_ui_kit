version: 2
jobs:
  build:
    docker:
      - image: changefinance/flutter-builder-docker:1.4.18
    environment:
      CODECOV_TOKEN: 2946bed5-f2c8-4478-a9d8-e553cce48cbc
    steps:
      - checkout
      - run: flutter doctor -v
      - run: flutter analyze
      - run: flutter -v test --concurrency=2

  update-version:
    docker:
      - image: alpine/git:1.0.7
    steps:
      - add_ssh_keys:
          fingerprints:
            - "5f:1a:11:5b:d5:55:f1:0a:3f:d3:ff:ce:91:36:5e:5b"
      - checkout
      - run: VERSION=`git describe --tags --abbrev=0 | awk -F. '{$NF+=1; OFS="."; print $0}'`
      - run: git tag $VERSION
      - run: git push --tags

workflows:
  version: 2
  changeapp-workflow:
    jobs:
      - build
      - update-version:
          requires:
            - build
          filters:
            branches:
              only: auto-tag-release
